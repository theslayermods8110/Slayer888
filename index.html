<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Editor de Vídeo Ultra-Fluido (Optimizado para Gama Baja)</title>
<style>
  :root { font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial; }
  body { margin: 0; background: #0b0b0f; color: #e6e6e9; display: flex; gap: 18px; padding: 14px; box-sizing: border-box; min-height: 100vh; }
  .col { display: flex; flex-direction: column; gap: 10px; }
  .controls { width: 360px; min-width: 240px; max-height: calc(100vh - 28px); overflow: auto; padding: 14px; background: linear-gradient(180deg, #0f1220, #0b0b12); border-radius: 12px; box-shadow: 0 6px 30px rgba(0, 0, 0, 0.6); }
  .viewer { flex: 1; display: flex; flex-direction: column; gap: 10px; min-width: 0; }
  label { font-size: 13px; color: #bfc4d6; }
  input[type=range] { width: 100%; cursor: pointer; }
  .row { display: flex; gap: 8px; align-items: center; }
  button, select, input[type=file] { transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease; }
  button { padding: 8px 12px; border-radius: 8px; border: none; background: #1f2937; color: #fff; cursor: pointer; }
  button:hover { background: #374151; box-shadow: 0 0 15px rgba(30, 41, 59, 0.7); }
  button:disabled { background: #374151; color: #9ca3af; cursor: not-allowed; }
  button.primary { background: #0ea5a4; }
  button.primary:hover { background: #14b8b6; box-shadow: 0 0 15px rgba(13, 148, 136, 0.7); }
  button.danger { background: #9f1239; }
  button.danger:hover { background: #e11d48; box-shadow: 0 0 15px rgba(159, 18, 57, 0.7); }
  select, input[type=file] { background: #0b0b12; color: #e6e6e9; padding: 8px; border-radius: 8px; border: 1px solid #1f2937; }
  small { color: #9aa2b2; }
  .status { font-size: 13px; color: #99a3b6; word-break: break-word; }
  .canvas-wrap { flex: 1; display: flex; flex-direction: column; gap: 8px; }
  canvas#glcanvas { background: #000; display: block; border-radius: 8px; width: 100%; height: calc(100vh - 220px); max-height: calc(100vh - 120px); object-fit: contain; image-rendering: pixelated; }
  .hint { font-size: 12px; color: #8892a6; }
  .seek { width: 100%; display: flex; gap: 8px; align-items: center; }
  .time { font-size: 12px; color: #9aa2b2; min-width: 68px; text-align: right; }
  @media (max-width: 900px) {
    body { flex-direction: column; padding: 10px; }
    .controls { width: 100%; max-height: none; }
    canvas#glcanvas { height: 60vh; max-height: none; }
  }
</style>
</head>
<body>
  <div class="col controls" id="controlsContainer">
    <h2>Editor Ultra-Fluido</h2>
    <label>Archivo de vídeo (local)</label>
    <input id="videoFile" type="file" accept="video/*" />
    <label>Resolución de salida (Bajas para +Velocidad)</label>
    <select id="outRes">
      <option value="1280x720" selected>720p HD (Recomendado)</option>
      <option value="1920x1080">1080p Full HD</option>
      <option value="3840x2160">4K UHD (¡Extremo lag!)</option>
      <option value="7680x4320">8K UHD (¡Imposible en gama baja!)</option>
    </select>
    <label>Escala / Modo</label>
    <select id="scaleMode">
      <option value="nearest" selected>Nearest (Máxima Velocidad)</option>
      <option value="bilinear">Bilinear (Balanceado)</option>
      <option value="bicubic">Bicubic + Sharpen (Máxima Calidad)</option>
    </select>
    <label>Filtros (Desactivados para +Velocidad)</label>
    <div>
      <div class="row"><label style="flex:1">Nitidez (Sharpen)</label><input id="sharpen" type="range" min="0" max="2" step="0.01" value="0" /></div>
      <div class="row"><label style="flex:1">Contraste</label><input id="contrast" type="range" min="0" max="2" step="0.01" value="1.0" /></div>
      <div class="row"><label style="flex:1">Saturación</label><input id="saturation" type="range" min="0" max="2" step="0.01" value="1.0" /></div>
      <div class="row"><label style="flex:1">Brillo</label><input id="brightness" type="range" min="0" max="2" step="0.01" value="1.0" /></div>
      <div class="row"><label style="flex:1">Reducción Ruido</label><input id="denoise" type="range" min="0" max="6" step="0.1" value="0" /></div>
    </div>
    <label>Controles</label>
    <div class="row">
      <button id="playBtn">▶ Reproducir</button>
      <button id="pauseBtn">⏸ Pausa</button>
      <button id="renderDownloadBtn" class="primary" disabled>⬇️ Render y Descargar</button>
      <button id="cancelRenderBtn" class="danger" style="display:none;">❌ Cancelar</button>
    </div>
    <div style="margin-top:8px"><div class="status" id="status">Estado: inactivo</div></div>
    <hr />
    <small class="hint">Rendimiento optimizado para gama baja. Evita filtros y altas resoluciones para máxima fluidez.</small>
  </div>
  <div class="viewer">
    <div style="display:flex;gap:8px;align-items:center">
      <div style="flex:1"><label>Preview</label></div>
      <div style="display:flex;gap:8px;align-items:center">
        <label class="hint">FPS preview:</label><select id="previewFps"><option selected>24</option><option>30</option><option>60</option></select>
      </div>
    </div>
    <div class="canvas-wrap">
      <canvas id="glcanvas"></canvas>
      <div class="seek">
        <input id="seekBar" type="range" min="0" step="0.01" value="0" style="flex:1"/>
        <div class="time"><span id="curTime">0:00</span> / <span id="durTime">0:00</span></div>
      </div>
      <video id="sourceVideo" crossorigin="anonymous" style="display:none"></video>
    </div>
  </div>

<script>
const VS=`attribute vec2 aPos;attribute vec2 aTex;varying vec2 vTex;void main(){vTex=aTex;gl_Position=vec4(aPos,0.0,1.0);}`;
const FS=`precision lowp float;varying vec2 vTex;uniform sampler2D uTex;uniform vec2 uTexSize;uniform float uSharpen;uniform float uContrast;uniform float uSaturation;uniform float uBrightness;uniform float uDenoise;uniform int uMode;vec4 textureBicubic(sampler2D s,vec2 uv){vec2 tS=uTexSize;vec2 px=1.0/tS;vec2 f=fract(uv*tS);vec2 c=uv-(f-0.5)*px;vec4 o=vec4(0.0);for(int j=-1;j<=2;j++){for(int i=-1;i<=2;i++){vec2 off=vec2(float(i),float(j))*px;o+=texture2D(s,c+off);}}return o/16.0;}vec3 rgb2hsv(vec3 c){vec4 K=vec4(0.0,-0.333,0.667,-1.0);vec4 p=mix(vec4(c.bg,K.wz),vec4(c.gb,K.xy),step(c.b,c.g));vec4 q=mix(vec4(p.xyw,c.r),vec4(c.r,p.yzx),step(p.x,c.r));float d=q.x-min(q.w,q.y);return vec3(abs(q.z+(q.w-q.y)/(6.0*d+1e-10)),d/(q.x+1e-10),q.x);}vec3 hsv2rgb(vec3 c){vec3 rgb=clamp(abs(mod(c.x*6.0+vec3(0.0,4.0,2.0),6.0)-3.0)-1.0,0.0,1.0);return c.z*mix(vec3(1.0),rgb,c.y);}void main(){vec4 col;if(uMode==2)col=texture2D(uTex,vTex);else if(uMode==1){col=textureBicubic(uTex,vTex);}else{col=texture2D(uTex,vTex);}if(uDenoise>0.01){vec2 px=1.0/uTexSize;vec4 sum=texture2D(uTex,vTex-px)+texture2D(uTex,vTex)+texture2D(uTex,vTex+px);col=mix(col,sum/3.0,clamp(uDenoise/6.0,0.0,1.0));}if(uSharpen>0.001){vec2 px=1.0/uTexSize;vec4 blur=texture2D(uTex,vTex-px)+texture2D(uTex,vTex)+texture2D(uTex,vTex+px);vec4 mask=col-blur/3.0;col+=mask*uSharpen;}vec3 c=col.rgb;if(uBrightness!=1.0)c*=uBrightness;if(uContrast!=1.0)c=((c-0.5)*uContrast)+0.5;if(uSaturation!=1.0){vec3 hsv=rgb2hsv(c);hsv.y*=uSaturation;c=hsv2rgb(hsv);}gl_FragColor=vec4(clamp(c,0.0,1.0),col.a);}`;

const canvas=document.getElementById('glcanvas'),video=document.getElementById('sourceVideo'),fileInput=document.getElementById('videoFile'),status=document.getElementById('status'),outRes=document.getElementById('outRes'),playBtn=document.getElementById('playBtn'),pauseBtn=document.getElementById('pauseBtn'),renderDownloadBtn=document.getElementById('renderDownloadBtn'),cancelRenderBtn=document.getElementById('cancelRenderBtn'),previewFps=document.getElementById('previewFps'),scaleMode=document.getElementById('scaleMode'),seekBar=document.getElementById('seekBar'),curTime=document.getElementById('curTime'),durTime=document.getElementById('durTime'),controlsContainer=document.getElementById('controlsContainer');
let gl,program,buffers={},uniforms={},animHandle=null,originalFileName='video',isUserSeeking=false,isRendering=false,isRenderCancelled=false;

function createGL(c){const gl=c.getContext('webgl',{antialias:false,powerPreference:'low-power'});if(!gl)throw new Error('Tu navegador no soporta WebGL');return gl;}
function compileShader(gl,src,type){const s=gl.createShader(type);gl.shaderSource(s,src);gl.compileShader(s);if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)){console.error('Error de Shader: '+gl.getShaderInfoLog(s));throw new Error('Error de Shader');}return s;}
function makeProgram(gl,vsSrc,fsSrc){const p=gl.createProgram(),vs=compileShader(gl,vsSrc,gl.VERTEX_SHADER),fs=compileShader(gl,fsSrc,gl.FRAGMENT_SHADER);gl.attachShader(p,vs);gl.attachShader(p,fs);gl.linkProgram(p);if(!gl.getProgramParameter(p,gl.LINK_STATUS)){console.error('Error de Programa: '+gl.getProgramInfoLog(p));throw new Error('Error de Programa');}return p;}
function throttle(func,limit){let inThrottle;return function(){const args=arguments,context=this;if(!inThrottle){func.apply(context,args);inThrottle=true;setTimeout(()=>inThrottle=false,limit);}}}

function initGL(width,height){canvas.width=width||640;canvas.height=height||360;if(!gl)gl=createGL(canvas);if(!program)program=makeProgram(gl,VS,FS);gl.useProgram(program);if(!buffers.vbo){const quad=new Float32Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]);buffers.vbo=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,buffers.vbo);gl.bufferData(gl.ARRAY_BUFFER,quad,gl.STATIC_DRAW);const aPos=gl.getAttribLocation(program,'aPos'),aTex=gl.getAttribLocation(program,'aTex');gl.enableVertexAttribArray(aPos);gl.vertexAttribPointer(aPos,2,gl.FLOAT,false,16,0);gl.enableVertexAttribArray(aTex);gl.vertexAttribPointer(aTex,2,gl.FLOAT,false,16,8);}const tex=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,tex);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);uniforms={uTex:gl.getUniformLocation(program,'uTex'),uTexSize:gl.getUniformLocation(program,'uTexSize'),uSharpen:gl.getUniformLocation(program,'uSharpen'),uContrast:gl.getUniformLocation(program,'uContrast'),uSaturation:gl.getUniformLocation(program,'uSaturation'),uBrightness:gl.getUniformLocation(program,'uBrightness'),uDenoise:gl.getUniformLocation(program,'uDenoise'),uMode:gl.getUniformLocation(program,'uMode')};}

function updateTextureFromVideo(){if(!gl||video.readyState<video.HAVE_CURRENT_DATA)return;gl.activeTexture(gl.TEXTURE0);const tex=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,tex);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,video);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);if(scaleMode.value==='nearest'){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);}else{gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);}gl.uniform1i(uniforms.uTex,0);gl.uniform2f(uniforms.uTexSize,video.videoWidth,video.videoHeight);}

function renderFrame(){if(video.readyState<2||!uniforms.uTex)return;updateTextureFromVideo();gl.useProgram(program);gl.uniform1f(uniforms.uSharpen,parseFloat(document.getElementById('sharpen').value));gl.uniform1f(uniforms.uContrast,parseFloat(document.getElementById('contrast').value));gl.uniform1f(uniforms.uSaturation,parseFloat(document.getElementById('saturation').value));gl.uniform1f(uniforms.uBrightness,parseFloat(document.getElementById('brightness').value));gl.uniform1f(uniforms.uDenoise,parseFloat(document.getElementById('denoise').value));let mode=0;if(scaleMode.value==='bicubic')mode=1;else if(scaleMode.value==='bilinear')mode=2;gl.uniform1i(uniforms.uMode,mode);gl.viewport(0,0,canvas.width,canvas.height);gl.drawArrays(gl.TRIANGLE_STRIP,0,4);}

function startPreviewLoop(){if(animHandle)return;const fps=parseInt(previewFps.value)||24,interval=1000/fps;let last=performance.now();function step(now){if(!isRendering&&(now-last<interval)){animHandle=requestAnimationFrame(step);return;}last=now;renderFrame();animHandle=requestAnimationFrame(step);}animHandle=requestAnimationFrame(step);}
function stopPreviewLoop(){if(animHandle)cancelAnimationFrame(animHandle);animHandle=null;}

fileInput.addEventListener('change',()=>{const f=fileInput.files&&fileInput.files[0];if(!f)return;originalFileName=f.name.substring(0,f.name.lastIndexOf('.'))||'export';video.src=URL.createObjectURL(f);video.load();video.onloadedmetadata=()=>{status.textContent=`Cargado: ${video.videoWidth}×${video.videoHeight} @ ${Math.round(video.duration)}s`;seekBar.max=video.duration;durTime.textContent=formatTime(video.duration);const[w,h]=outRes.value.split('x').map(v=>parseInt(v,10));try{initGL(w,h);}catch(e){alert('Error WebGL: '+e.message);return;}video.addEventListener('canplay',()=>renderFrame(),{once:true});renderDownloadBtn.disabled=false;};});

playBtn.addEventListener('click',()=>{if(video.src){video.play();startPreviewLoop();status.textContent='Estado: reproduciendo';}else alert('Carga un archivo de vídeo primero');});
pauseBtn.addEventListener('click',()=>{video.pause();stopPreviewLoop();status.textContent='Estado: pausa';});
outRes.addEventListener('change',()=>{if(!video.src)return;const[w,h]=outRes.value.split('x').map(v=>parseInt(v,10));initGL(w,h);renderFrame();});

seekBar.addEventListener('input',()=>{isUserSeeking=true;curTime.textContent=formatTime(parseFloat(seekBar.value||0));});
seekBar.addEventListener('change',()=>{const t=parseFloat(seekBar.value||0);video.currentTime=t;isUserSeeking=false;renderFrame();});
video.addEventListener('timeupdate',()=>{if(!isUserSeeking){seekBar.value=video.currentTime;curTime.textContent=formatTime(video.currentTime);}});
video.addEventListener('seeked',()=>renderFrame());
video.addEventListener('durationchange',()=>{seekBar.max=video.duration;durTime.textContent=formatTime(video.duration);});

function formatTime(s){if(!s||isNaN(s)||s===Infinity)return'0:00';const mm=Math.floor(s/60),ss=Math.floor(s%60).toString().padStart(2,'0');return`${mm}:${ss}`;}

const throttledRender=throttle(()=>{if(!isRendering)renderFrame();},100);
['sharpen','contrast','saturation','brightness','denoise','scaleMode'].forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('input',throttledRender);});
outRes.addEventListener('input',()=>{if(outRes.value.startsWith('3840')||outRes.value.startsWith('7680')){if(!confirm('¡ADVERTENCIA! Esta resolución causará lag extremo o puede colapsar tu navegador. ¿Continuar?'))outRes.value='1280x720';}});
window.addEventListener('keydown',(e)=>{if(e.code==='Space'&&document.activeElement.tagName!=='BUTTON'&&!isRendering){e.preventDefault();if(video.paused)playBtn.click();else pauseBtn.click();}});

function setControlsEnabled(enabled){controlsContainer.querySelectorAll('input, button, select').forEach(el=>el.disabled=!enabled);renderDownloadBtn.style.display=enabled?'inline-block':'none';cancelRenderBtn.style.display=enabled?'none':'inline-block';if(enabled){renderDownloadBtn.disabled=!video.src;cancelRenderBtn.disabled=true;}else{cancelRenderBtn.disabled=false;}}

cancelRenderBtn.addEventListener('click', ()=>{if(isRendering)isRenderCancelled=true;});

renderDownloadBtn.addEventListener('click',async()=>{if(!video.src||isRendering)return;if(!canvas.captureStream)return alert('Tu navegador no soporta canvas.captureStream. Usa Chrome/Edge/Firefox moderno.');
  isRendering=true;isRenderCancelled=false;setControlsEnabled(false);stopPreviewLoop();
  
  const[w,h]=outRes.value.split('x').map(v=>parseInt(v,10));initGL(w,h);
  const fps=parseInt(previewFps.value)||24;const stream=canvas.captureStream(fps);let mr;
  try{mr=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8,opus'});}catch(e){try{mr=new MediaRecorder(stream,{mimeType:'video/webm'});}catch(e2){alert('Error MediaRecorder: no se soportan los codecs necesarios.');isRendering=false;setControlsEnabled(true);return;}}
  
  let recordedChunks=[];mr.ondataavailable=ev=>{if(ev.data&&ev.data.size>0)recordedChunks.push(ev.data);};
  mr.onstop=()=>{
    if(isRenderCancelled){
      status.textContent='Render cancelado por el usuario.';
    }else{
      const blob=new Blob(recordedChunks,{type:'video/webm'});const date=new Date();const ts=`${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}`;const newFileName=`${originalFileName}_${outRes.value}_${ts}.webm`,url=URL.createObjectURL(blob);const a=document.createElement('a');a.style.display='none';a.href=url;a.download=newFileName;document.body.appendChild(a);a.click();URL.revokeObjectURL(url);document.body.removeChild(a);
      status.textContent='Render completado. ¡Archivo descargado!';
    }
    isRendering=false;isRenderCancelled=false;video.muted=false;setControlsEnabled(true);
  };
  
  try{
    status.textContent='Iniciando render...';video.pause();video.muted=true;video.currentTime=0;await new Promise(r=>setTimeout(r,100));
    recordedChunks=[];mr.start();
    
    const totalFrames=Math.ceil(video.duration*fps);
    for(let frame=0;frame<=totalFrames;frame++){
      if(isRenderCancelled)break;
      const time=frame/fps;
      if(time>video.duration)break;
      video.currentTime=time;
      await new Promise(resolve=>video.addEventListener('seeked',resolve,{once:true}));
      renderFrame();
      const percent=totalFrames>0?Math.floor((frame/totalFrames)*100):0;status.textContent=`Renderizando... ${percent}%`;
      await new Promise(r=>setTimeout(r,0));
    }
    mr.stop();
  }catch(err){
    console.error('Error durante render:',err);alert('Error durante el render: '+err.message);
    if(mr&&mr.state==='recording')mr.stop();
    isRendering=false;setControlsEnabled(true);status.textContent='Error en render.';
  }});
</script>
</body>
</html>            min-height: 100vh;
            padding: 30px 15px;
            font-size: 18px;
            line-height: 1.6;
        }
        .enchanting-panel {
            background-color: var(--panel-bg);
            border: 5px solid black; /* Borde exterior cambiado a negro */
            border-radius: 18px;
            padding: 25px;
            width: 95%;
            max-width: 900px;
            box-shadow: 0 0 25px var(--panel-border-glow), inset 0 0 10px rgba(0,0,0,0.4); /* Brillo morado mantenido */
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        .panel-header {
            text-align: center;
            border-bottom: 3px dashed var(--panel-border); /* Línea discontinua morada mantenida */
            padding-bottom: 20px;
            margin-bottom: 10px;
        }
        .panel-header h1 {
            color: var(--highlight-color);
            font-size: 2.8em;
            margin-bottom: 15px;
            text-shadow: 3px 3px #1a0f28;
        }
        .panel-header h1 i {
            color: var(--accent-color);
        }
        .enchanting-gif {
            max-width: 120px;
            border-radius: 8px;
            border: 3px solid var(--highlight-color);
            box-shadow: 0 0 10px var(--panel-border-glow);
            background-color: rgba(0,0,0,0.2);
        }
        .section {
            background-color: rgba(0, 0, 0, 0.2);
            border: 2px solid var(--enchant-border); /* Borde interior morado tenue mantenido */
            border-radius: 10px;
            padding: 20px;
            transition: opacity 0.3s ease;
        }
        .section h2, .section h3 {
            color: var(--highlight-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--highlight-color);
            padding-bottom: 8px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        #item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
            gap: 15px;
            justify-content: center;
        }
        .item-icon-button {
            background-color: var(--item-bg);
            border: 3px solid var(--disabled-color);
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            padding: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 72px;
            height: 72px;
            overflow: hidden;
        }
        .item-icon-button img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            image-rendering: pixelated;
            display: block;
        }
        .item-icon-button .load-error {
             display: flex;
             justify-content: center;
             align-items: center;
             width: 100%;
             height: 100%;
             font-size: 2em;
             color: var(--error-color);
             font-weight: bold;
        }
        .item-icon-button:hover {
            transform: scale(1.08);
            border-color: var(--highlight-color);
            box-shadow: 0 0 8px var(--panel-border-glow);
        }
        .item-icon-button.selected {
            border-color: var(--success-color);
            box-shadow: 0 0 10px var(--success-color);
            transform: scale(1.05);
        }
        .current-item-display .item-info-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        #selected-item-icon {
            width: 64px;
            height: 64px;
            object-fit: contain;
            image-rendering: pixelated;
            background: var(--item-bg);
            padding: 5px;
            border-radius: 6px;
            border: 2px solid var(--highlight-color);
        }
         #selected-item-icon.load-error {
            border: 2px dashed var(--error-color);
        }
        #selected-item-name {
            font-size: 2em;
            font-weight: bold;
            color: var(--text-color);
            border: none;
            padding: 0;
            margin: 0;
        }
        #applied-enchants-area ul {
            list-style: none;
            padding: 0;
            max-height: 150px;
            overflow-y: auto;
            padding-right: 5px;
        }
        #applied-enchants-area li {
            background-color: rgba(160, 80, 255, 0.2);
            border-left: 5px solid var(--highlight-color);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
        }
        #applied-enchants-area li.empty-message {
            background-color: transparent;
            border-left: none;
            color: var(--disabled-color);
            font-style: italic;
            justify-content: center;
        }
        .remove-enchant-btn {
            background-color: var(--error-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .remove-enchant-btn:hover {
            background-color: #d84343;
        }
        #enchantment-list-container {
            max-height: 350px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .enchantment-item {
            background-color: var(--enchant-bg);
            padding: 12px 15px;
            margin-bottom: 12px;
            border-radius: 6px;
            border: 1px solid var(--enchant-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            transition: background-color 0.2s;
        }
        .enchantment-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }
        .enchantment-name {
            font-weight: bold;
            flex-grow: 1;
            min-width: 180px;
            font-size: 1.2em;
            color: var(--highlight-color);
        }
        .enchantment-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .enchantment-item select {
            font-family: 'VT323', monospace;
            background-color: var(--panel-bg);
            color: var(--text-color);
            border: 2px solid var(--highlight-color);
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 1em;
            cursor: pointer;
        }
        .add-enchant-btn {
            background-color: var(--success-color);
            color: var(--panel-bg);
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.2s, opacity 0.2s;
        }
        .add-enchant-btn:hover:not(:disabled) {
            background-color: #4fd47b;
        }
        .add-enchant-btn:disabled {
            background-color: var(--disabled-color);
            opacity: 0.7;
            cursor: not-allowed;
        }
        .finalize-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        #finalize-button, #back-to-items-button, #reset-button {
            flex: 1 1 200px;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 1.4em;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #finalize-button {
            background-color: var(--highlight-color);
            box-shadow: 0 4px var(--panel-border);
        }
        #finalize-button:hover:not(:disabled) {
            background-color: #8a4dff;
            box-shadow: 0 2px var(--panel-border);
            transform: translateY(2px);
        }
        #finalize-button:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
             box-shadow: 0 4px #444;
             transform: none;
        }
        #back-to-items-button {
            background-color: var(--accent-color);
            color: var(--panel-bg);
            box-shadow: 0 4px #ccaa00;
            order: -1;
        }
        #back-to-items-button:hover {
            background-color: #e6b800;
            box-shadow: 0 2px #ccaa00;
            transform: translateY(2px);
        }
        #summary-panel {
            border-color: var(--success-color);
            box-shadow: 0 0 15px rgba(107, 255, 156, 0.5);
        }
        #final-item-display {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(107, 255, 156, 0.1);
            border-radius: 8px;
        }
        #final-item-display img {
            width: 96px;
            height: 96px;
            object-fit: contain;
            image-rendering: pixelated;
            margin-bottom: 10px;
            border: 3px solid var(--success-color);
            border-radius: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
        }
         #final-item-display img.load-error {
             border: 3px dashed var(--error-color);
             background: var(--item-bg);
        }
        #final-item-display h3 {
            font-size: 2.2em;
            color: var(--success-color);
            border: none;
            padding: 0;
            margin: 0;
        }
        #summary-list {
            list-style: none;
            padding: 0;
        }
        #summary-list li {
            margin-bottom: 15px;
            padding: 12px 15px;
            background-color: rgba(107, 255, 156, 0.15);
            border-left: 6px solid var(--success-color);
            border-radius: 6px;
        }
        #summary-list strong {
            color: var(--highlight-color);
            display: block;
            margin-bottom: 5px;
            font-size: 1.3em;
        }
        #summary-list span {
            font-size: 1.1em;
            color: var(--text-color);
        }
        #reset-button {
            background-color: var(--error-color);
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 4px #d84343;
            order: 1;
            flex-basis: 100%;
        }
        #reset-button:hover {
            background-color: #d84343;
            box-shadow: 0 2px #d84343;
            transform: translateY(2px);
        }
        .hidden {
            display: none !important;
        }
        .error-box {
            color: #fff;
            background-color: rgba(255, 107, 107, 0.8);
            padding: 12px 15px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid var(--error-color);
            text-align: center;
            font-size: 1.1em;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        ::-webkit-scrollbar {
          width: 10px;
        }
        ::-webkit-scrollbar-track {
          background: var(--panel-bg);
          border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
          background: var(--highlight-color);
          border-radius: 10px;
          border: 2px solid var(--panel-bg);
        }
        ::-webkit-scrollbar-thumb:hover {
          background: #8a4dff;
        }
        i {
            vertical-align: middle;
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <div class="enchanting-panel">
        <div class="panel-header">
            <h1><i class="fas fa-book-sparkles"></i> Minecraft Enchanter <i class="fas fa-book-sparkles"></i></h1> {/* Encabezado cambiado */}
            <img src="https://media.tenor.com/xE9_TS0Gv7cAAAAi/minecraft-enchant.gif" alt="Libro Encantado Animado" class="enchanting-gif">
        </div>

        <div class="section item-selection active-section" id="item-selection-section">
            <h2><i class="fas fa-tools"></i> 1. Elige un Ítem para Encantar</h2>
            <div id="item-grid">
                <p>Cargando ítems...</p>
            </div>
        </div>

        <div id="enchanting-process" class="hidden">
            <div class="section current-item-display">
                <div class="item-info-header">
                    <img id="selected-item-icon" src="" alt="Ítem Seleccionado">
                    <h2 id="selected-item-name">Ítem Seleccionado</h2>
                </div>
                <div id="applied-enchants-area">
                    <h3><i class="fas fa-layer-group"></i> Encantamientos Aplicados (<span id="enchant-count">0</span>/<span id="max-enchants">?</span>)</h3>
                    <ul id="current-enchants-list"></ul>
                </div>
                <div id="error-message" class="error-box hidden"></div>
            </div>

            <div class="section available-enchants">
                <h2><i class="fas fa-wand-magic-sparkles"></i> 2. Elige Encantamientos</h2>
                <div id="enchantment-list-container">
                     <p id="no-enchants-message" class="hidden">Cargando encantamientos...</p>
                </div>
            </div>

            <div class="section finalize-section">
                 <button id="back-to-items-button"><i class="fas fa-arrow-left"></i> Elegir Otro</button>
                 <button id="finalize-button" disabled><i class="fas fa-check-circle"></i> ¡Terminar!</button>
            </div>
        </div>

         <div id="summary-panel" class="hidden section">
             <h2><i class="fas fa-star"></i> ¡Tu Ítem Encantado! <i class="fas fa-star"></i></h2>
             <div id="final-item-display">
                 <img id="final-item-icon" src="" alt="Ítem Final Encantado">
                 <h3 id="final-item-name"></h3>
             </div>
             <div id="final-enchants-summary">
                 <h3><i class="fas fa-list-check"></i> Beneficios Obtenidos:</h3>
                 <ul id="summary-list"></ul>
             </div>
             <button id="reset-button"><i class="fas fa-redo"></i> Encantar Otro Ítem</button>
         </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const itemGrid = document.getElementById('item-grid');
            const itemSelectionSection = document.getElementById('item-selection-section');
            const enchantingProcessSection = document.getElementById('enchanting-process');
            const summaryPanel = document.getElementById('summary-panel');
            const selectedItemIcon = document.getElementById('selected-item-icon');
            const selectedItemName = document.getElementById('selected-item-name');
            const enchantCountSpan = document.getElementById('enchant-count');
            const maxEnchantsSpan = document.getElementById('max-enchants');
            const currentEnchantsList = document.getElementById('current-enchants-list');
            const errorMessageDiv = document.getElementById('error-message');
            const enchantmentListContainer = document.getElementById('enchantment-list-container');
            const noEnchantsMessage = document.getElementById('no-enchants-message');
            const finalizeButton = document.getElementById('finalize-button');
            const backToItemsButton = document.getElementById('back-to-items-button');
            const finalItemIcon = document.getElementById('final-item-icon');
            const finalItemName = document.getElementById('final-item-name');
            const summaryList = document.getElementById('summary-list');
            const resetButton = document.getElementById('reset-button');

            const MC_ASSET_BASE_URL = 'https://assets.mcasset.cloud/1.20.4/assets/minecraft/textures/item/';

            const items = [
                { id: 'wooden_sword', name: 'Espada de Madera', icon: `${MC_ASSET_BASE_URL}wooden_sword.png`, type: 'sword', maxEnchants: 5 },
                { id: 'stone_sword', name: 'Espada de Piedra', icon: `${MC_ASSET_BASE_URL}stone_sword.png`, type: 'sword', maxEnchants: 5 },
                { id: 'iron_sword', name: 'Espada de Hierro', icon: `${MC_ASSET_BASE_URL}iron_sword.png`, type: 'sword', maxEnchants: 5 },
                { id: 'golden_sword', name: 'Espada de Oro', icon: `${MC_ASSET_BASE_URL}golden_sword.png`, type: 'sword', maxEnchants: 5 },
                { id: 'diamond_sword', name: 'Espada de Diamante', icon: `${MC_ASSET_BASE_URL}diamond_sword.png`, type: 'sword', maxEnchants: 6 },
                { id: 'netherite_sword', name: 'Espada de Netherita', icon: `${MC_ASSET_BASE_URL}netherite_sword.png`, type: 'sword', maxEnchants: 7 },
                { id: 'wooden_pickaxe', name: 'Pico de Madera', icon: `${MC_ASSET_BASE_URL}wooden_pickaxe.png`, type: 'pickaxe', maxEnchants: 4 },
                { id: 'stone_pickaxe', name: 'Pico de Piedra', icon: `${MC_ASSET_BASE_URL}stone_pickaxe.png`, type: 'pickaxe', maxEnchants: 4 },
                { id: 'iron_pickaxe', name: 'Pico de Hierro', icon: `${MC_ASSET_BASE_URL}iron_pickaxe.png`, type: 'pickaxe', maxEnchants: 4 },
                { id: 'golden_pickaxe', name: 'Pico de Oro', icon: `${MC_ASSET_BASE_URL}golden_pickaxe.png`, type: 'pickaxe', maxEnchants: 4 },
                { id: 'diamond_pickaxe', name: 'Pico de Diamante', icon: `${MC_ASSET_BASE_URL}diamond_pickaxe.png`, type: 'pickaxe', maxEnchants: 5 },
                { id: 'netherite_pickaxe', name: 'Pico de Netherita', icon: `${MC_ASSET_BASE_URL}netherite_pickaxe.png`, type: 'pickaxe', maxEnchants: 6 },
                { id: 'wooden_axe', name: 'Hacha de Madera', icon: `${MC_ASSET_BASE_URL}wooden_axe.png`, type: 'axe', maxEnchants: 5 },
                { id: 'stone_axe', name: 'Hacha de Piedra', icon: `${MC_ASSET_BASE_URL}stone_axe.png`, type: 'axe', maxEnchants: 5 },
                { id: 'iron_axe', name: 'Hacha de Hierro', icon: `${MC_ASSET_BASE_URL}iron_axe.png`, type: 'axe', maxEnchants: 5 },
                { id: 'golden_axe', name: 'Hacha de Oro', icon: `${MC_ASSET_BASE_URL}golden_axe.png`, type: 'axe', maxEnchants: 5 },
                { id: 'diamond_axe', name: 'Hacha de Diamante', icon: `${MC_ASSET_BASE_URL}diamond_axe.png`, type: 'axe', maxEnchants: 6 },
                { id: 'netherite_axe', name: 'Hacha de Netherita', icon: `${MC_ASSET_BASE_URL}netherite_axe.png`, type: 'axe', maxEnchants: 7 },
                { id: 'wooden_shovel', name: 'Pala de Madera', icon: `${MC_ASSET_BASE_URL}wooden_shovel.png`, type: 'shovel', maxEnchants: 4 },
                { id: 'stone_shovel', name: 'Pala de Piedra', icon: `${MC_ASSET_BASE_URL}stone_shovel.png`, type: 'shovel', maxEnchants: 4 },
                { id: 'iron_shovel', name: 'Pala de Hierro', icon: `${MC_ASSET_BASE_URL}iron_shovel.png`, type: 'shovel', maxEnchants: 4 },
                { id: 'golden_shovel', name: 'Pala de Oro', icon: `${MC_ASSET_BASE_URL}golden_shovel.png`, type: 'shovel', maxEnchants: 4 },
                { id: 'diamond_shovel', name: 'Pala de Diamante', icon: `${MC_ASSET_BASE_URL}diamond_shovel.png`, type: 'shovel', maxEnchants: 5 },
                { id: 'netherite_shovel', name: 'Pala de Netherita', icon: `${MC_ASSET_BASE_URL}netherite_shovel.png`, type: 'shovel', maxEnchants: 6 },
                { id: 'wooden_hoe', name: 'Azada de Madera', icon: `${MC_ASSET_BASE_URL}wooden_hoe.png`, type: 'hoe', maxEnchants: 4 },
                { id: 'stone_hoe', name: 'Azada de Piedra', icon: `${MC_ASSET_BASE_URL}stone_hoe.png`, type: 'hoe', maxEnchants: 4 },
                { id: 'iron_hoe', name: 'Azada de Hierro', icon: `${MC_ASSET_BASE_URL}iron_hoe.png`, type: 'hoe', maxEnchants: 4 },
                { id: 'golden_hoe', name: 'Azada de Oro', icon: `${MC_ASSET_BASE_URL}golden_hoe.png`, type: 'hoe', maxEnchants: 4 },
                { id: 'diamond_hoe', name: 'Azada de Diamante', icon: `${MC_ASSET_BASE_URL}diamond_hoe.png`, type: 'hoe', maxEnchants: 5 },
                { id: 'netherite_hoe', name: 'Azada de Netherita', icon: `${MC_ASSET_BASE_URL}netherite_hoe.png`, type: 'hoe', maxEnchants: 6 },
                { id: 'bow', name: 'Arco', icon: `${MC_ASSET_BASE_URL}bow.png`, type: 'bow', maxEnchants: 5 },
                { id: 'crossbow', name: 'Ballesta', icon: `${MC_ASSET_BASE_URL}crossbow_standby.png`, type: 'crossbow', maxEnchants: 4 },
                { id: 'fishing_rod', name: 'Caña de Pescar', icon: `${MC_ASSET_BASE_URL}fishing_rod.png`, type: 'fishing_rod', maxEnchants: 4 },
                { id: 'trident', name: 'Tridente', icon: `${MC_ASSET_BASE_URL}trident.png`, type: 'trident', maxEnchants: 5 },
                { id: 'shears', name: 'Tijeras', icon: `${MC_ASSET_BASE_URL}shears.png`, type: 'shears', maxEnchants: 3 },
                { id: 'flint_and_steel', name: 'Mechero', icon: `${MC_ASSET_BASE_URL}flint_and_steel.png`, type: 'flint_and_steel', maxEnchants: 2 },
                { id: 'shield', name: 'Escudo', icon: `https://minecraft.wiki/images/Shield_JE2_BE1.png`, type: 'shield', maxEnchants: 2 }, // URL de minecraft.wiki para el escudo
                { id: 'elytra', name: 'Elytra', icon: `${MC_ASSET_BASE_URL}elytra.png`, type: 'elytra', maxEnchants: 2 },
                { id: 'leather_helmet', name: 'Gorra de Cuero', icon: `${MC_ASSET_BASE_URL}leather_helmet.png`, type: 'helmet', maxEnchants: 5 },
                { id: 'chainmail_helmet', name: 'Casco de Malla', icon: `${MC_ASSET_BASE_URL}chainmail_helmet.png`, type: 'helmet', maxEnchants: 5 },
                { id: 'iron_helmet', name: 'Casco de Hierro', icon: `${MC_ASSET_BASE_URL}iron_helmet.png`, type: 'helmet', maxEnchants: 5 },
                { id: 'golden_helmet', name: 'Casco de Oro', icon: `${MC_ASSET_BASE_URL}golden_helmet.png`, type: 'helmet', maxEnchants: 5 },
                { id: 'diamond_helmet', name: 'Casco de Diamante', icon: `${MC_ASSET_BASE_URL}diamond_helmet.png`, type: 'helmet', maxEnchants: 5 },
                { id: 'netherite_helmet', name: 'Casco de Netherita', icon: `${MC_ASSET_BASE_URL}netherite_helmet.png`, type: 'helmet', maxEnchants: 6 },
                { id: 'turtle_helmet', name: 'Caparazón de Tortuga', icon: `${MC_ASSET_BASE_URL}turtle_helmet.png`, type: 'helmet', maxEnchants: 5 },
                { id: 'leather_chestplate', name: 'Túnica de Cuero', icon: `${MC_ASSET_BASE_URL}leather_chestplate.png`, type: 'chestplate', maxEnchants: 5 },
                { id: 'chainmail_chestplate', name: 'Pechera de Malla', icon: `${MC_ASSET_BASE_URL}chainmail_chestplate.png`, type: 'chestplate', maxEnchants: 5 },
                { id: 'iron_chestplate', name: 'Pechera de Hierro', icon: `${MC_ASSET_BASE_URL}iron_chestplate.png`, type: 'chestplate', maxEnchants: 5 },
                { id: 'golden_chestplate', name: 'Pechera de Oro', icon: `${MC_ASSET_BASE_URL}golden_chestplate.png`, type: 'chestplate', maxEnchants: 5 },
                { id: 'diamond_chestplate', name: 'Pechera de Diamante', icon: `${MC_ASSET_BASE_URL}diamond_chestplate.png`, type: 'chestplate', maxEnchants: 5 },
                { id: 'netherite_chestplate', name: 'Pechera de Netherita', icon: `${MC_ASSET_BASE_URL}netherite_chestplate.png`, type: 'chestplate', maxEnchants: 6 },
                { id: 'leather_leggings', name: 'Pantalones de Cuero', icon: `${MC_ASSET_BASE_URL}leather_leggings.png`, type: 'leggings', maxEnchants: 5 },
                { id: 'chainmail_leggings', name: 'Grebas de Malla', icon: `${MC_ASSET_BASE_URL}chainmail_leggings.png`, type: 'leggings', maxEnchants: 5 },
                { id: 'iron_leggings', name: 'Grebas de Hierro', icon: `${MC_ASSET_BASE_URL}iron_leggings.png`, type: 'leggings', maxEnchants: 5 },
                { id: 'golden_leggings', name: 'Grebas de Oro', icon: `${MC_ASSET_BASE_URL}golden_leggings.png`, type: 'leggings', maxEnchants: 5 },
                { id: 'diamond_leggings', name: 'Grebas de Diamante', icon: `${MC_ASSET_BASE_URL}diamond_leggings.png`, type: 'leggings', maxEnchants: 5 },
                { id: 'netherite_leggings', name: 'Grebas de Netherita', icon: `${MC_ASSET_BASE_URL}netherite_leggings.png`, type: 'leggings', maxEnchants: 6 },
                { id: 'leather_boots', name: 'Botas de Cuero', icon: `${MC_ASSET_BASE_URL}leather_boots.png`, type: 'boots', maxEnchants: 5 },
                { id: 'chainmail_boots', name: 'Botas de Malla', icon: `${MC_ASSET_BASE_URL}chainmail_boots.png`, type: 'boots', maxEnchants: 5 },
                { id: 'iron_boots', name: 'Botas de Hierro', icon: `${MC_ASSET_BASE_URL}iron_boots.png`, type: 'boots', maxEnchants: 5 },
                { id: 'golden_boots', name: 'Botas de Oro', icon: `${MC_ASSET_BASE_URL}golden_boots.png`, type: 'boots', maxEnchants: 5 },
                { id: 'diamond_boots', name: 'Botas de Diamante', icon: `${MC_ASSET_BASE_URL}diamond_boots.png`, type: 'boots', maxEnchants: 5 },
                { id: 'netherite_boots', name: 'Botas de Netherita', icon: `${MC_ASSET_BASE_URL}netherite_boots.png`, type: 'boots', maxEnchants: 6 },
            ];

             const enchantments = {
                protection: { id: 'protection', name: 'Protección', maxLevel: 4, applicableTo: ['helmet', 'chestplate', 'leggings', 'boots'], incompatibleWith: ['blast_protection', 'fire_protection', 'projectile_protection'], description: 'Reduce la mayoría de los tipos de daño.' },
                blast_protection: { id: 'blast_protection', name: 'Protección contra Explosiones', maxLevel: 4, applicableTo: ['helmet', 'chestplate', 'leggings', 'boots'], incompatibleWith: ['protection', 'fire_protection', 'projectile_protection'], description: 'Reduce el daño y el empuje de las explosiones.' },
                fire_protection: { id: 'fire_protection', name: 'Protección contra el Fuego', maxLevel: 4, applicableTo: ['helmet', 'chestplate', 'leggings', 'boots'], incompatibleWith: ['protection', 'blast_protection', 'projectile_protection'], description: 'Reduce el daño por fuego y el tiempo que permaneces ardiendo.' },
                projectile_protection: { id: 'projectile_protection', name: 'Protección contra Proyectiles', maxLevel: 4, applicableTo: ['helmet', 'chestplate', 'leggings', 'boots'], incompatibleWith: ['protection', 'blast_protection', 'fire_protection'], description: 'Reduce el daño de proyectiles (flechas, bolas de fuego, etc.).' },
                thorns: { id: 'thorns', name: 'Espinas', maxLevel: 3, applicableTo: ['helmet', 'chestplate', 'leggings', 'boots'], incompatibleWith: [], description: 'Tiene una probabilidad de infligir daño a los atacantes. Consume durabilidad extra.' },
                unbreaking: { id: 'unbreaking', name: 'Irrompibilidad', maxLevel: 3, applicableTo: ['helmet', 'chestplate', 'leggings', 'boots', 'sword', 'pickaxe', 'axe', 'shovel', 'hoe', 'fishing_rod', 'bow', 'crossbow', 'trident', 'shield', 'elytra', 'shears', 'flint_and_steel'], incompatibleWith: [], description: 'Aumenta la durabilidad efectiva del ítem.' },
                mending: { id: 'mending', name: 'Reparación', maxLevel: 1, applicableTo: ['helmet', 'chestplate', 'leggings', 'boots', 'sword', 'pickaxe', 'axe', 'shovel', 'hoe', 'fishing_rod', 'bow', 'crossbow', 'trident', 'shield', 'elytra', 'shears', 'flint_and_steel'], incompatibleWith: ['infinity'], isTreasure: true, description: 'Repara el ítem usando orbes de experiencia. (Tesoro)' },
                vanishing_curse: { id: 'vanishing_curse', name: 'Maldición de Desaparición', maxLevel: 1, applicableTo: ['helmet', 'chestplate', 'leggings', 'boots', 'sword', 'pickaxe', 'axe', 'shovel', 'hoe', 'fishing_rod', 'bow', 'crossbow', 'trident', 'shield', 'elytra', 'shears', 'flint_and_steel'], incompatibleWith: [], isCurse: true, description: 'El ítem desaparece al morir el jugador. (Maldición)' },
                binding_curse: { id: 'binding_curse', name: 'Maldición de Ligamento', maxLevel: 1, applicableTo: ['helmet', 'chestplate', 'leggings', 'boots'], incompatibleWith: [], isCurse: true, description: 'Impide quitarse la pieza de armadura una vez puesta (hasta que se rompa o mueras). (Maldición)' },
                respiration: { id: 'respiration', name: 'Respiración', maxLevel: 3, applicableTo: ['helmet'], incompatibleWith: [], description: 'Aumenta el tiempo de respiración bajo el agua y mejora la visión.' },
                aqua_affinity: { id: 'aqua_affinity', name: 'Afinidad Acuática', maxLevel: 1, applicableTo: ['helmet'], incompatibleWith: [], description: 'Elimina la penalización de velocidad al minar bajo el agua.' },
                depth_strider: { id: 'depth_strider', name: 'Agilidad Acuática', maxLevel: 3, applicableTo: ['boots'], incompatibleWith: ['frost_walker'], description: 'Aumenta la velocidad de movimiento bajo el agua.' },
                frost_walker: { id: 'frost_walker', name: 'Paso Helado', maxLevel: 2, applicableTo: ['boots'], incompatibleWith: ['depth_strider'], isTreasure: true, description: 'Convierte el agua bajo tus pies en hielo frágil. Daña con bloques de magma. (Tesoro)' },
                feather_falling: { id: 'feather_falling', name: 'Caída de Pluma', maxLevel: 4, applicableTo: ['boots'], incompatibleWith: [], description: 'Reduce el daño por caída.' },
                soul_speed: { id: 'soul_speed', name: 'Velocidad del Alma', maxLevel: 3, applicableTo: ['boots'], incompatibleWith: [], isTreasure: true, description: 'Aumenta la velocidad de movimiento sobre arena de almas y tierra de almas. (Tesoro)' },
                swift_sneak: { id: 'swift_sneak', name: 'Sigilo Rápido', maxLevel: 3, applicableTo: ['leggings'], incompatibleWith: [], isTreasure: true, description: 'Aumenta la velocidad de movimiento al agacharse. (Tesoro - Solo en Ciudades Antiguas)' },
                sharpness: { id: 'sharpness', name: 'Filo / Agudeza', maxLevel: 5, applicableTo: ['sword', 'axe'], incompatibleWith: ['smite', 'bane_of_arthropods'], description: 'Aumenta el daño cuerpo a cuerpo general.' },
                smite: { id: 'smite', name: 'Golpeo', maxLevel: 5, applicableTo: ['sword', 'axe'], incompatibleWith: ['sharpness', 'bane_of_arthropods'], description: 'Aumenta el daño contra muertos vivientes (zombies, esqueletos, withers, etc.).' },
                bane_of_arthropods: { id: 'bane_of_arthropods', name: 'Perdición de los Artrópodos', maxLevel: 5, applicableTo: ['sword', 'axe'], incompatibleWith: ['sharpness', 'smite'], description: 'Aumenta el daño contra artrópodos (arañas, abejas, lepismas, etc.) y aplica lentitud.' },
                knockback: { id: 'knockback', name: 'Empuje', maxLevel: 2, applicableTo: ['sword'], incompatibleWith: [], description: 'Aumenta el retroceso infligido a los enemigos.' },
                fire_aspect: { id: 'fire_aspect', name: 'Aspecto Ígneo', maxLevel: 2, applicableTo: ['sword'], incompatibleWith: [], description: 'Prende fuego a los enemigos golpeados.' },
                looting: { id: 'looting', name: 'Saqueo / Botín', maxLevel: 3, applicableTo: ['sword'], incompatibleWith: [], description: 'Aumenta la cantidad y probabilidad de obtener objetos de los mobs.' },
                sweeping_edge: { id: 'sweeping_edge', name: 'Filo Arrasador', maxLevel: 3, applicableTo: ['sword'], incompatibleWith: [], description: 'Aumenta el daño de los ataques de barrido (Java Edition).' },
                efficiency: { id: 'efficiency', name: 'Eficiencia', maxLevel: 5, applicableTo: ['pickaxe', 'shovel', 'axe', 'hoe', 'shears'], incompatibleWith: [], description: 'Aumenta la velocidad de minado/ruptura de bloques.' },
                silk_touch: { id: 'silk_touch', name: 'Toque de Seda', maxLevel: 1, applicableTo: ['pickaxe', 'shovel', 'axe', 'hoe', 'shears'], incompatibleWith: ['fortune'], isTreasure: false, description: 'Hace que los bloques minados suelten el propio bloque (ej. piedra, mena, hierba).' },
                fortune: { id: 'fortune', name: 'Fortuna', maxLevel: 3, applicableTo: ['pickaxe', 'shovel', 'axe', 'hoe'], incompatibleWith: ['silk_touch'], description: 'Aumenta la cantidad de ítems soltados por ciertos bloques (ej. carbón, diamantes, cultivos).' },
                power: { id: 'power', name: 'Poder', maxLevel: 5, applicableTo: ['bow'], incompatibleWith: [], description: 'Aumenta el daño de las flechas.' },
                punch: { id: 'punch', name: 'Retroceso', maxLevel: 2, applicableTo: ['bow'], incompatibleWith: [], description: 'Aumenta el empuje de las flechas.' },
                flame: { id: 'flame', name: 'Fuego', maxLevel: 1, applicableTo: ['bow'], incompatibleWith: [], description: 'Las flechas prenden fuego a los objetivos.' },
                infinity: { id: 'infinity', name: 'Infinidad', maxLevel: 1, applicableTo: ['bow'], incompatibleWith: ['mending'], description: 'Permite disparar flechas infinitamente si tienes al menos una flecha. No funciona con flechas de efectos.' },
                multishot: { id: 'multishot', name: ' Multidisparo', maxLevel: 1, applicableTo: ['crossbow'], incompatibleWith: ['piercing'], description: 'Dispara 3 proyectiles (flechas o cohetes) consumiendo solo uno.' },
                piercing: { id: 'piercing', name: 'Perforación', maxLevel: 4, applicableTo: ['crossbow'], incompatibleWith: ['multishot'], description: 'Los proyectiles atraviesan entidades.' },
                quick_charge: { id: 'quick_charge', name: 'Carga Rápida', maxLevel: 3, applicableTo: ['crossbow'], incompatibleWith: [], description: 'Reduce el tiempo de recarga de la ballesta.' },
                lure: { id: 'lure', name: 'Atracción', maxLevel: 3, applicableTo: ['fishing_rod'], incompatibleWith: [], description: 'Reduce el tiempo de espera para que piquen los peces.' },
                luck_of_the_sea: { id: 'luck_of_the_sea', name: 'Suerte Marina', maxLevel: 3, applicableTo: ['fishing_rod'], incompatibleWith: [], description: 'Aumenta la probabilidad de pescar tesoros y reduce la de pescar basura.' },
                impaling: { id: 'impaling', name: 'Empalamiento', maxLevel: 5, applicableTo: ['trident'], incompatibleWith: [], description: 'Aumenta el daño contra criaturas acuáticas (Java: solo acuáticas, Bedrock: todas si están en agua/lluvia).' },
                riptide: { id: 'riptide', name: 'Propulsión Acuática / Corriente', maxLevel: 3, applicableTo: ['trident'], incompatibleWith: ['loyalty', 'channeling'], description: 'Impulsa al jugador cuando se lanza el tridente en agua o bajo la lluvia. El tridente no se puede lanzar normalmente.' },
                loyalty: { id: 'loyalty', name: 'Lealtad', maxLevel: 3, applicableTo: ['trident'], incompatibleWith: ['riptide'], description: 'El tridente regresa al jugador después de ser lanzado.' },
                channeling: { id: 'channeling', name: 'Conductividad', maxLevel: 1, applicableTo: ['trident'], incompatibleWith: ['riptide'], description: 'Invoca un rayo sobre un mob golpeado si hay tormenta eléctrica.' },
            };

            let selectedItem = null;
            let appliedEnchantments = {};

            function levelToRoman(num) {
                if (!num || num < 1 || num > 10) return num ? num.toString() : '';
                const roman = ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"];
                return roman[num];
            }

            function showError(message) {
                errorMessageDiv.textContent = message;
                errorMessageDiv.classList.remove('hidden');
                setTimeout(() => { errorMessageDiv.classList.add('hidden'); }, 4000);
            }

            function clearError() {
                errorMessageDiv.classList.add('hidden');
                errorMessageDiv.textContent = '';
            }

            function updateEnchantCount() {
                const count = Object.keys(appliedEnchantments).length;
                enchantCountSpan.textContent = count;
                maxEnchantsSpan.textContent = selectedItem ? selectedItem.maxEnchants : '?';
                finalizeButton.disabled = count === 0;
            }

            function isEnchantmentIncompatible(newEnchantId) {
                const newEnchantData = enchantments[newEnchantId];
                if (!newEnchantData || !newEnchantData.incompatibleWith) return false;
                for (const appliedId in appliedEnchantments) {
                    if (newEnchantData.incompatibleWith.includes(appliedId)) {
                        return enchantments[appliedId]?.name || appliedId;
                    }
                    const appliedEnchantData = enchantments[appliedId];
                    if (appliedEnchantData?.incompatibleWith && appliedEnchantData.incompatibleWith.includes(newEnchantId)) {
                        return appliedEnchantData.name || appliedId;
                    }
                }
                return false;
            }

            function handleImageError(event) {
                const button = event.target.closest('.item-icon-button');
                if (button) {
                    button.innerHTML = '<span class="load-error">?</span>';
                    button.title = `${button.title} (Imagen no disp.)`;
                } else {
                     event.target.classList.add('load-error');
                     event.target.alt = 'Imagen no disponible';
                }
             }

            function populateItemGrid() {
                itemGrid.innerHTML = '';
                items.forEach(item => {
                    const button = document.createElement('button');
                    button.classList.add('item-icon-button');
                    button.dataset.itemId = item.id;
                    button.title = item.name;
                    const img = document.createElement('img');
                    img.src = item.icon;
                    img.alt = item.name;
                    img.loading = 'lazy';
                    img.onerror = handleImageError;
                    button.appendChild(img);
                    button.addEventListener('click', () => selectItem(item.id));
                    itemGrid.appendChild(button);
                });
            }

            function selectItem(itemId) {
                selectedItem = items.find(item => item.id === itemId);
                if (!selectedItem) return;
                appliedEnchantments = {};
                clearError();
                document.querySelectorAll('.item-icon-button').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.itemId === itemId);
                });
                selectedItemIcon.src = selectedItem.icon;
                selectedItemIcon.alt = selectedItem.name;
                selectedItemIcon.onerror = handleImageError;
                selectedItemIcon.classList.remove('load-error');
                selectedItemName.textContent = selectedItem.name;
                updateEnchantCount();
                renderAppliedEnchantments();
                populateAvailableEnchantments();
                itemSelectionSection.classList.add('hidden');
                enchantingProcessSection.classList.remove('hidden');
                summaryPanel.classList.add('hidden');
            }

            function goBackToItemSelection() {
                selectedItem = null;
                appliedEnchantments = {};
                clearError();
                document.querySelectorAll('.item-icon-button.selected').forEach(btn => btn.classList.remove('selected'));
                itemSelectionSection.classList.remove('hidden');
                enchantingProcessSection.classList.add('hidden');
                summaryPanel.classList.add('hidden');
                finalizeButton.disabled = true;
            }

            function renderAppliedEnchantments() {
                currentEnchantsList.innerHTML = '';
                if (Object.keys(appliedEnchantments).length === 0) {
                    const li = document.createElement('li');
                    li.classList.add('empty-message');
                    li.textContent = 'Aún no has añadido encantamientos.';
                    currentEnchantsList.appendChild(li);
                    updateEnchantmentAvailability();
                    return;
                }
                const sortedEnchantIds = Object.keys(appliedEnchantments).sort((a, b) => (enchantments[a]?.name || a).localeCompare(enchantments[b]?.name || b));
                sortedEnchantIds.forEach(enchantId => {
                    const level = appliedEnchantments[enchantId];
                    const enchantData = enchantments[enchantId];
                    if (!enchantData) return;
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${enchantData.name} ${levelToRoman(level)}</span><button class="remove-enchant-btn" data-enchant-id="${enchantId}" title="Quitar"><i class="fas fa-times"></i></button>`;
                    li.querySelector('.remove-enchant-btn').addEventListener('click', (e) => removeEnchantment(e.currentTarget.dataset.enchantId));
                    currentEnchantsList.appendChild(li);
                });
                updateEnchantmentAvailability();
            }

            function populateAvailableEnchantments() {
                enchantmentListContainer.innerHTML = '';
                let hasApplicableEnchants = false;
                const sortedEnchantmentKeys = Object.keys(enchantments).sort((a,b) => (enchantments[a]?.name || a).localeCompare(enchantments[b]?.name || b));
                sortedEnchantmentKeys.forEach(enchantKey => {
                     const enchant = enchantments[enchantKey];
                    if (selectedItem && enchant.applicableTo.includes(selectedItem.type)) {
                        hasApplicableEnchants = true;
                        const div = document.createElement('div');
                        div.classList.add('enchantment-item');
                        div.dataset.enchantId = enchant.id;
                        const nameSpan = document.createElement('span');
                        nameSpan.classList.add('enchantment-name');
                        nameSpan.textContent = enchant.name;
                        if (enchant.isTreasure) nameSpan.textContent += " (T)";
                        if (enchant.isCurse) nameSpan.textContent += " (M)";
                        const controlsDiv = document.createElement('div');
                        controlsDiv.classList.add('enchantment-controls');
                        const select = document.createElement('select');
                        select.title = `Nivel ${enchant.name}`;
                        for (let i = 1; i <= enchant.maxLevel; i++) {
                            const option = document.createElement('option');
                            option.value = i;
                            option.textContent = levelToRoman(i);
                            select.appendChild(option);
                        }
                        if (enchant.maxLevel > 1) select.value = enchant.maxLevel;
                        const addButton = document.createElement('button');
                        addButton.classList.add('add-enchant-btn');
                        addButton.innerHTML = `<i class="fas fa-plus"></i>`;
                        addButton.title = `Añadir ${enchant.name}`;
                        addButton.dataset.enchantId = enchant.id;
                        addButton.addEventListener('click', () => addEnchantment(enchant.id, parseInt(select.value)));
                        controlsDiv.appendChild(select);
                        controlsDiv.appendChild(addButton);
                        div.appendChild(nameSpan);
                        div.appendChild(controlsDiv);
                        enchantmentListContainer.appendChild(div);
                    }
                });
                noEnchantsMessage.classList.toggle('hidden', hasApplicableEnchants);
                if (!hasApplicableEnchants) noEnchantsMessage.textContent = "No hay encantamientos compatibles.";
                updateEnchantmentAvailability();
            }

            function addEnchantment(enchantId, level) {
                clearError();
                const enchantData = enchantments[enchantId];
                if (!enchantData || !selectedItem) return;
                if (Object.keys(appliedEnchantments).length >= selectedItem.maxEnchants) {
                    showError(`Límite: ${selectedItem.maxEnchants} encantamientos.`);
                    return;
                }
                if (appliedEnchantments.hasOwnProperty(enchantId)) {
                    showError(`"${enchantData.name}" ya aplicado.`);
                    return;
                }
                const incompatibleName = isEnchantmentIncompatible(enchantId);
                if (incompatibleName) {
                    showError(`Incompatible con "${incompatibleName}".`);
                    return;
                }
                appliedEnchantments[enchantId] = level;
                renderAppliedEnchantments();
                updateEnchantCount();
            }

            function removeEnchantment(enchantId) {
                if (appliedEnchantments.hasOwnProperty(enchantId)) {
                    delete appliedEnchantments[enchantId];
                    clearError();
                    renderAppliedEnchantments();
                    updateEnchantCount();
                }
            }

            function updateEnchantmentAvailability() {
                const addButtons = enchantmentListContainer.querySelectorAll('.add-enchant-btn');
                const currentEnchantCount = Object.keys(appliedEnchantments).length;
                const maxReached = selectedItem ? currentEnchantCount >= selectedItem.maxEnchants : true;
                addButtons.forEach(button => {
                    const enchantId = button.dataset.enchantId;
                    if (!enchantId) return;
                    const isAlreadyApplied = appliedEnchantments.hasOwnProperty(enchantId);
                    const incompatibleName = isEnchantmentIncompatible(enchantId);
                    const shouldDisable = (maxReached && !isAlreadyApplied) || isAlreadyApplied || !!incompatibleName;
                    button.disabled = shouldDisable;
                    if (shouldDisable) {
                         let title = '';
                         if (isAlreadyApplied) title = `Ya aplicado`;
                         else if (incompatibleName) title = `Incompatible: ${incompatibleName}`;
                         else if (maxReached) title = `Límite alcanzado`;
                         button.title = title;
                    } else {
                        button.title = `Añadir ${enchantments[enchantId]?.name || enchantId}`;
                    }
                });
            }

            function finalizeEnchanting() {
                if (!selectedItem || Object.keys(appliedEnchantments).length === 0) {
                    showError("Selecciona ítem y añade encantamientos.");
                    return;
                }
                clearError();
                finalItemIcon.src = selectedItem.icon;
                finalItemIcon.alt = `Final: ${selectedItem.name}`;
                finalItemIcon.onerror = handleImageError;
                finalItemIcon.classList.remove('load-error');
                finalItemName.textContent = `${selectedItem.name} Encantado`;
                summaryList.innerHTML = '';
                const sortedEnchantIds = Object.keys(appliedEnchantments).sort((a, b) => (enchantments[a]?.name || a).localeCompare(enchantments[b]?.name || b));
                sortedEnchantIds.forEach(id => {
                    const level = appliedEnchantments[id];
                    const enchantData = enchantments[id];
                    if (enchantData) {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong><i class="fas fa-star"></i> ${enchantData.name} ${levelToRoman(level)}</strong><span>${enchantData.description}</span>`;
                        summaryList.appendChild(li);
                    }
                });
                enchantingProcessSection.classList.add('hidden');
                summaryPanel.classList.remove('hidden');
            }

            function resetSimulator() {
                goBackToItemSelection();
            }

            populateItemGrid();
            backToItemsButton.addEventListener('click', goBackToItemSelection);
            finalizeButton.addEventListener('click', finalizeEnchanting);
            resetButton.addEventListener('click', resetSimulator);

        });
    </script>
</body>
</html>
